<link href="//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-form-validator/2.3.26/jquery.form-validator.min.js"></script>
<style>
    .store_detail_content.no_border {
        border-bottom: none;
    }
    .gs_text {
        font-family: lora-regular;
        font-size: 14pt;
        line-height: 26pt;
        color:#6d6e71;
    }
    .store_detail_content {
        margin-bottom: 54px;
        padding-bottom: 54px;
    }
    .title {
        margin-top: 0px !important;
        margin-bottom: 30px;
        font-family: railway-regular;
        font-size: 28pt;
        color: #6d6e71;
        text-transform: uppercase;
    }
    .margin_30 {
        margin-bottom: 30px;
    }
    .margin_50 {
        margin-bottom: 50px;
    }
    .flex-row {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
    }
    legend {
        margin-bottom: 5px;
        border-bottom: none;
        font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        font-weight: 700;
        font-size: 14px;
        line-height: 1.42857143;
        
    }
    fieldset label {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
        font-weight: normal;
    }
    fieldset label .iradio_square {
        margin-right: 5px;
    }
    .gray_pill {
        margin-left: 0;
    }
    .has-error {
        position: relative;
    }
    .form-error {
        position: absolute;
        bottom: 0;
    }
    .iradio_square .form-error {
        min-width: 150px;
        position: absolute;
        bottom: -60px;
    }
</style>

<div id="page_banner">
    <div class="banner_wrapper">
        <h1 class="page_headline">Lost & Found</h1>
        <div class="missing_out_div">
            <p onclick="javascript:toggle_news_form()">Get the Latest<i id="fear_caret" class="fa fa-caret-down"></i></p>
            <div class="hidden_newsletter_form">
                <form style="font-size:12px" id="banner_newsletter">
                    <span>
                        <input id="banner_email" name="cm-iixuu-iixuu" type="email" required  placeholder="Email address"/>
                        <button type="submit" id="banner_submit">Subscribe</button>
                    </span>
                    <br>
                    <input id="banner_agree_terms" type="checkbox" required value="I agree to receive newsletters from The Bay Centre">
                    <label for="banner_aggree_terms" class="checkbox_lbl">I agree to receive newsletters from The Bay Centre</label>
                    <input type="hidden" name="cm-f-jhtykd" id ="banner_source" />
                    <input type="hidden" name="cm-f-jhtykh" id="banner_terms"/>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="share_this_icon_div">
    <span class='st_sharethis'></span>   
</div>

<div id="main_container">
    <div class="store_detail_content">
        <div id="mm_page_content" class="gs_text"></div>
    </div>
    <div class="store_detail_content no_border">
        <div class="row">
            <div class="col-md-12">
                <p class="gs_text">Please complete as much of this form as possible for any lost and found items from within the Bay Centre only. You will be notified within 48 hours regarding the status of your lost and found claim.</p>
                <hr>
            </div>
        </div>
        <form id="security_form" class="margin_50">
            <label for="propert_id" style="display:none">Property ID</label>
            <input id="propert_id" name="contest[property_id]" style="display:none" value="{{property_id}}" />
            <label for="contest_id" style="display:none">Contest ID</label>
            <input id="contest_id" name="contest[contest_id]" style="display:none" value="{{id}}" />
            <div class="row flex-row">
                <div class="col-md-6">
                    <h1 class="title">Contact Information</h1>
                </div>
                <div class="col-md-6">
                    <p class="pull-right">* fields marked with asterik are manditory</p>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="name">Full Name</label>  
                    <input class="form-control margin_30" id="name" name="contest[name]" type="text" required data-validation="required"/>
                </div>
                <div class="col-md-6">
                    <label for="email">Email *</label> 
                    <input class="form-control margin_30" id="email" name="contest[email]" type="email" required data-validation-regexp="^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$" data-validation-error-msg="Please enter a valid email address" data-validation="custom"/>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="phone">Phone Number</label>  
                    <input class="form-control margin_30" id="phone" name="contest[phone]" type="text"/>    
                </div>
                <div class="col-md-6">
                    <label for="alt_phone">Alternate Phone Number (Optional)</label>  
                    <input class="form-control margin_30" id="alt_phone" name="contest[alt_phone]" type="text" />    
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <hr class="margin_50">
                    <h1 class="title">Item Information</h1>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 margin_30">
                    <fieldset>
                        <legend>Are you reporting this item lost or found *</legend>
                        <label for="item_lost">
                            <input type="radio" id="item_lost" name="lost_found" value="Lost" required data-validation="required"> Lost
                        </label>
                        <label for="item_found">
                            <input type="radio" id="item_found" name="lost_found" value="Found"> Found
                        </label>
                    </fieldset>
                </div>
                <div class="col-md-6">
                    <label for="item-select">What type of item are you reporting *</label>
                    <select id="item-select" class="form-control margin_30" required data-validation="required">
                        <option value="">- Please select an option -</option>
                        <option value="cell phone">Cell Phone</option>
                        <option value="wallet">Wallet</option>
                        <option value="credit card">Credit Card</option>
                        <option value="passport">Passport or Personal ID</option>
                        <option value="clothing">Clothing</option>
                        <option value="jewelry">Jewelry</option>
                        <option value="Bottles, Cups, or Mugs">Bottles, Cups, or Mugs</option>
                        <option value="Eyewear">Eyewear</option>
                        <option value="Money or Gift Cards">Money or Gift Cards</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="date">Date *</label>  
                    <input class="form-control margin_30" id="date" name="contest[date]" type="text" placeholder="MM/DD/YYYY" data-validation="date" data-validation-require-leading-zero="false" data-validation-format="mm/dd/yyyy" required />    
                </div>
                <div class="col-md-6">
                    <label for="time">Time *</label>  
                    <input class="form-control margin_30" id="time" name="contest[time]" type="text" placeholder="HH:mm" data-validation="time" required />    
                </div>
            </div>
            <div class="row ">
                <div class="col-md-12">
                    <label for="description">Describe the item in detail *</label>  
                    <textarea class="form-control margin_30" id="description" name="contest[description]" type="text" rows="4" required data-validation="required"/></textarea>
                </div>
            </div>
            <div class="row ">
                <div class="col-md-12">
                    <label for="location">Describe where the item was lost or found *</label>  
                    <textarea class="form-control margin_30" id="location" name="contest[location]" type="text" rows="4" required data-validation="required"/></textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button class="gray_pill submit_btn">Submit</button>
                </div>
            </div>
        </form>
        <div id="send_contact_success" class="hidden_now alert alert-success text-left" role="alert">
            <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
            <span class="sr-only">Success</span>
            Thank you for your submission. A member from our team will contact you shortly.
        </div>
        <div id="send_contact_error" class="hidden_now alert alert-danger text-left" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Error:</span>
            There was an error when trying to submit your request. Please try again later.
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        function renderAll(){
            var page_banner = getRepoDetailsByName('Lost & Found').images;
            var banner_url = "";
            $.each(page_banner, function(key, val){
                banner_url = val.image_url;
            });
            $("#page_banner").css({backgroundImage: "url(" + banner_url + ")"});
            
            var prefix = get_prefix();
            var pages_json = prefix + "/pages/baycentre-lost-found.json"
            $.getJSON(pages_json).done(function(data) {
                $('#mm_page_content').html(data.body);
            });
            
            var page_array = [""]
            page_array = page_array.reverse()
            full_page_array = []
            $.ajaxSetup({
                async: false
            });
            $.each( page_array , function( key, val ) {
                var pages_json = prefix+"/pages/" + val + ".json"
                $.getJSON(pages_json).then(function(data) {
                    add_to_page_array (data)
                });
            });
            $.ajaxSetup({
                async: true
            });
            
            var contests = getContestList();
            console.log(contests)
            var current_contest = [];
            $.each(contests, function(key, val){
                if(val.slug === "baycentre-lost-found") {
                    current_contest.push(val);
                } 
            });
            var slug = current_contest[0].slug;
         console.log("slug", slug)
            renderPageData("#cat_stores_container","#cat_stores_template",full_page_array, "pages")
            
            $(".loading_overlay").hide();
            $("#page_content").show();
            
            $.validate({
                modules : 'date'
            });
            
            $('#security_form').submit(function(e){
                e.preventDefault();
                $('.submit_btn').prop('disabled', true);
                submit_contest(slug);
                // $('html, body').animate(
                //     { scrollTop: 0 }, 800
                // );
            });
        }
        
        function add_to_page_array (data){
            full_page_array.push(data)
        }
        
        function renderPageData(container, template, collection, type){
            var item_list = [];
            var item_rendered = [];
            var template_html = $(template).html();
            Mustache.parse(template_html);   // optional, speeds up future uses
            $.each( collection , function( key, val ) {
                var title = val.title.split(" - ");
                val.title = title[1]
                
                var rendered = Mustache.render(template_html,val);
                item_rendered.push(rendered);
            });
            $(container).show();
            $(container).html(item_rendered.join(''));
        };
        
        function submit_contest(slug) {
            var lost_found = "";
            if ($("input[name='lost_found']:checked").val()) {
                lost_found = "Lost";
            } else if ($("input[name='lost_found']:checked").val()) {
                lost_found = "Found";
            }

            // Format contest data for MM
            var contest_data = {};
            contest_data.full_name = $('#name').val();
            contest_data.email = $('#email').val();
            contest_data.phone_number = $('#phone').val();
            contest_data.alt_phone_number = $('#alt_phone').val();
            contest_data.lost_or_found = $("input[name='lost_found']:checked").val();
            contest_data.item_type = $('#item-select').find(":selected").text();
            contest_data.date = $('#date').val();
            contest_data.time = $('#time').val();
            contest_data.item_description = $('#description').val();
            contest_data.item_location = $('#location').val();
            console.log("entry", contest_data)
            
            // Format email data
            var contact_form = {};
            contact_form.send_to = "caitlin@mobilefringe.com";
            contact_form.subject = "Lost & Found Form Submission";
            var body = {};
            body["Full Name"] = $('#name').val();
            body["Email"] = $('#email').val();
            body["Phone Number"] = $('#phone').val();
            body["Alternate Phone Number"] = $('#alt_phone').val();
            body["Was Item Lost or Found?"] = $("input[name='lost_found']:checked").val();
            body["Type of Item"] = $('#item-select').find(":selected").text();
            body["Date"] = $('#date').val();
            body["Time"] = $('#time').val();
            body["Item Description"] = $('#description').val();
            body["Item Location"] = $('#location').val();

            // Sending email
            send_data = {};
            send_data.url = "https://www.mallmaverick.com/send_contact_email";
            send_data.form_data = JSON.stringify(serializeObject(contact_form));
            contact_form.body = body;

            $.ajax({
                url : send_data.url,
                type: "POST",
                data : contact_form,
                success: function(data, textStatus, jqXHR){
                    var contest_entry = {};
                    contest_entry.json = contest_data;
                    var propertyDetails = getPropertyDetails();
                    var host = propertyDetails.mm_host.replace("http:", "");
                    var url = host + "/contests/" + slug + "/json_entry";
                    $.ajax({
                        url: url,
                        type: "POST",
                        data: contest_entry,
                        async: false,
                        success: function(data) {
                          console.log("mm post successful");
                          $("#send_contact_success").show();
                        },
                        error: function(data){
                            console.log("error data:" , data);
                            $("#send_contact_error").show();
                        }
                    });
                },
                error: function (jqXHR, textStatus, errorThrown){
                  console.log("Data load error: " + error.message);
                //   vm.formError = true;
                }
            });
        }
        
        function serializeObject(obj) {
            var newObj = [];
            $.each(obj, function(key, value) {
                var tempVal = {};
                tempVal.name = key;
                tempVal.value = value;
                newObj.push(tempVal);
            });
            return newObj;
        }
        
        loadMallDataCached(renderAll); 
    })
</script>