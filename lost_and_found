<link href="//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-form-validator/2.3.26/jquery.form-validator.min.js"></script>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>
<style>
    .store_detail_content.no_border {
        Margin-top: 54px;
        border-bottom: none;
    }
    .gs_text {
        font-family: lora-regular;
        font-size: 14pt;
        line-height: 26pt;
        color:#6d6e71;
    }
    .store_detail_content {
        margin-bottom: 54px;
        padding-bottom: 54px;
    }
    .title {
        margin-top: 0px !important;
        margin-bottom: 30px;
        font-family: railway-regular;
        font-size: 28pt;
        color: #6d6e71;
        text-transform: uppercase;
    }
    .margin_30 {
        margin-bottom: 30px;
    }
    .margin_50 {
        margin-bottom: 50px;
    }
    .flex-row {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
    }
    #fieldEmail {
        margin: 0;
        margin-bottom: 30px;
        padding-left: 12px;
        width: 100%;
        height: 34px;
        border: 1px solid #ccc;
        background-color: #FFF;
        color: #555 !important;
    }
    legend {
        margin-bottom: 5px;
        border-bottom: none;
        font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        font-weight: 700;
        font-size: 14px;
        line-height: 1.42857143;
        
    }
    fieldset label {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
        font-weight: normal;
    }
    fieldset label .iradio_square {
        margin-right: 5px;
    }
    .gray_pill {
        margin-left: 0;
    }
    .has-error {
        position: relative;
    }
    .form-error {
        position: absolute;
        bottom: 0;
    }
    .iradio_square .form-error {
        min-width: 150px;
        position: absolute;
        bottom: -60px;
    }
    .accordion .btn.btn-link {
        white-space: normal;
        text-align: left;
    }
    .accordion .card-header .btn{
        background: #f1f0ed;
        margin-bottom: 5px;
        text-transform: uppercase;
        line-height: 2;
            padding: 10px 0;
        padding-left: 39px;
        padding-right: 34px;
        font-family: montserrat-regular;
        font-size: 16px;
        color: #4d4d4f;
        position: relative;
        width: 100%;
    }
    .accordion .card-body {
        color: #6d6e71;
        font-family: lora-regular;
        /* font-family: neuton \9; */
        font-size: 14pt;
        line-height: 26pt;
    }
    @media (max-width: 767px) {
        #fieldEmail {
            max-width: 100%;
            border-radius: 4px;
        }
    }
    @media (max-width: 425px) {
        .flex-row {
            margin-bottom: 20px;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            -ms-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: start;
            -webkit-align-items: flex-start;
            -ms-flex-align: start;
            align-items: flex-start;    
        }
        .title {
            margin-bottom: 20px;
        }
        
    }
</style>

<div id="page_banner">
    <div class="banner_wrapper">
        <h1 class="page_headline">Lost & Found</h1>
        <div class="missing_out_div">
            <p onclick="javascript:toggle_news_form()">Get the Latest<i id="fear_caret" class="fa fa-caret-down"></i></p>
            <div class="hidden_newsletter_form">
                <form style="font-size:12px" id="banner_newsletter">
                    <span>
                        <input id="banner_email" name="cm-iixuu-iixuu" type="email" required  placeholder="Email address"/>
                        <button type="submit" id="banner_submit">Subscribe</button>
                    </span>
                    <br>
                    <input id="banner_agree_terms" type="checkbox" required value="I agree to receive newsletters from The Bay Centre">
                    <label for="banner_aggree_terms" class="checkbox_lbl">I agree to receive newsletters from The Bay Centre</label>
                    <input type="hidden" name="cm-f-jhtykd" id ="banner_source" />
                    <input type="hidden" name="cm-f-jhtykh" id="banner_terms"/>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="share_this_icon_div">
    <span class='st_sharethis'></span>   
</div>

<div id="main_container">
    <div class="store_detail_content">
        <div id="mm_page_content" class="gs_text"></div>
    </div>
    <div class="store_detail_content no_border">
        <div class="row">
            <div class="col-md-12">
                <p class="gs_text margin_50">Please complete as much of this form as possible for any lost and found items from within the Bay Centre only. You will be notified within 48 hours regarding the status of your lost and found claim. Please see below for frequently asked questions.</p>
                <hr class="margin_50">
            </div>
        </div>
        <form id="subForm" class="js-cm-form" action="https://www.createsend.com/t/subscribeerror?description=" method="post"> <!-- data-id="92D4C54F0FEC16E5ADC2B1904DE9ED1A8842F5D4F604C2DA717DB8EC28A8C682DF3DFD8448DB7258DE4A25F522C85FA76CD38A3DA1209E8E33BF7B30B790DF24" -->
            <div class="row flex-row">
                <div class="col-md-6">
                    <h1 class="title">Contact Information</h1>
                </div>
                <div class="col-md-6">
                    <p class="pull-right">* Fields marked with asterisk are mandatory</p>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                     <input class="form-control margin_30" id="fieldName" name="cm-name" type="hidden"/>
                    <label for="fieldFirstName">First Name *</label>  
                    <input class="form-control margin_30" id="fieldFirstName" name="firstName" type="text" required data-validation="required"/>
                </div>
                <div class="col-md-6">
                    <label for="fieldLastName">Last Name *</label>  
                    <input class="form-control margin_30" id="fieldLastName" name="lastName" type="text" required data-validation="required"/>
                </div>
                
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="fieldEmail">Email *</label> 
                    <input class="form-control margin_30 js-cm-email-input" id="fieldEmail" name="cm-ydjkjul-ydjkjul" type="email" required data-validation-regexp="^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$" data-validation-error-msg="Please enter a valid email address" data-validation="custom"/>
                </div>
                <div class="col-md-6">
                    <label for="fieldwdiat">Phone Number *</label>  
                    <input class="form-control margin_30" id="fieldwdiat" name="cm-f-wdiat" type="text" required data-validation="required"/>    
                </div>
                <div class="col-md-6">
                    <label for="fieldwdiad">Alternate Phone Number (Optional)</label>  
                    <input class="form-control margin_30" id="fieldwdiad" name="cm-f-wdiad" type="text" />    
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <hr class="margin_50">
                    <h1 class="title">Item Information</h1>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 margin_30">
                    <label for="fieldwdiad">Are you reporting this item lost or found *</label>
                    <select id="fieldwdiah" class="form-control margin_30" name="cm-fo-wdiah" required data-validation="required">
                        <option value="">- Please select an option -</option>
                        <option value="Lost">Lost</option>
                        <option value="Found">Found</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="fieldwdifi">What type of item are you reporting *</label>
                    <select id="fieldwdifi" class="form-control margin_30" name="cm-fo-wdifi" required data-validation="required">
                        <option value="">- Please select an option -</option>
                        <option value="cell phone">Cell Phone</option>
                        <option value="wallet">Wallet</option>
                        <option value="credit card">Credit Card</option>
                        <option value="passport">Passport or Personal ID</option>
                        <option value="clothing">Clothing</option>
                        <option value="jewelry">Jewelry</option>
                        <option value="Bottles, Cups, or Mugs">Bottles, Cups, or Mugs</option>
                        <option value="Eyewear">Eyewear</option>
                        <option value="Money or Gift Cards">Money or Gift Cards</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="fieldwdizl">Date you lost/found item *</label>  
                    <input class="form-control margin_30" id="fieldwdizl" name="cm-f-wdizl" type="date" placeholder="MM/DD/YYYY" data-validation="required" required />    
                </div>
                <div class="col-md-6">
                    <label for="fieldwdifh">Time</label>  
                    <input class="form-control margin_30 timepicker" id="fieldwdifh" name="cm-f-wdifh" type="text" placeholder="HH:mm" data-validation="time" />    
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <label for="fieldwdifk">Describe the item in detail *</label>  
                    <textarea class="form-control margin_30" id="fieldwdifk" name="cm-f-wdifk" type="text" rows="4" data-validation="required" required></textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <label for="fieldwdifu">Describe where the item was lost or found *</label>  
                    <textarea class="form-control margin_30" id="fieldwdifu" name="cm-f-wdifu" type="text" rows="4" required data-validation="required"></textarea>
                </div>
            </div>
            <div class="hide_input">
                <label for="fieldydiyily">Confirmation Code</label>
                <input id="fieldydiyily" name="cm-f-ydiyily" type="text" />
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button class="gray_pill submit_btn js-cm-submit-button" type="submit">Submit</button>
                </div>
            </div>
        </form>
        <!--<script type="text/javascript" src="https://js.createsend1.com/javascript/copypastesubscribeformlogic.js"></script>-->
    </div>
    <div class="store_detail_content no_border">
        <div class="row">
            <div class="col-md-12">
                <h1 class="title">Lost & Found FAQs</h1>
                <!--<div id="mm_subpage_content" class="gs_text"></div>-->
                <div class="accordion" id="mm_subpage_container">
                    <script id="mm_subpage_template" type="x-tmpl-mustache/text">
                      <div class="card accordion-group">
                        <div class="card-header" id="heading{{id}}">
                          <h2 class="mb-0">
                            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse{{id}}" aria-expanded="true" aria-controls="collapse{{id}}">
                             {{title}}
                            </button>
                          </h2>
                        </div>
                    
                        <div id="collapse{{id}}" class="collapse" aria-labelledby="heading{{id}}" data-parent="#mm_subpage_container">
                          <div class="card-body">
                            {{{body}}}
                          </div>
                        </div>
                      </div>
                    </script>
                 </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        function renderAll(){
            // add timepicker
            $('.timepicker').timepicker({
                timeFormat: 'h:mm p',
                interval: 30,
                // minTime: '10',
                // maxTime: '6:00pm',
                // defaultTime: '11',
                // startTime: '10:00',
                dynamic: false,
                dropdown: true,
                scrollbar: true
            });
            
            var page_banner = getRepoDetailsByName('Lost & Found').images;
            var banner_url = "";
            $.each(page_banner, function(key, val){
                banner_url = val.image_url;
            });
            $("#page_banner").css({backgroundImage: "url(" + banner_url + ")"});
            
            var prefix = get_prefix();
            var main_page_json = prefix + "/pages/baycentre-lost-found.json"
            $.getJSON(main_page_json).done(function(data) {
                $('#mm_page_content').html(data.body);
            });
            
            var sub_page_json = prefix + "/pages/baycentre-lost-found-faqs.json"
            $.getJSON(sub_page_json).done(function(data) {
                $('#mm_subpage_content').html(data.body);
                if(data.subpages && data.subpages.length > 0) {
                    renderGeneral('#mm_subpage_container','#mm_subpage_template', data.subpages)
                }
            });
            
            var contests = getContestList();
            var current_contest = [];
            $.each(contests, function(key, val){
                if(val.slug === "baycentre-lost-found") {
                    current_contest.push(val);
                } 
            });
            var slug = current_contest[0].slug;

            $(".loading_overlay").hide();
            $("#page_content").show();

            
            $('#subForm').submit(function(e){
                e.preventDefault();
                $('.submit_btn').prop('disabled', true);
                submit_contest(slug, e);
            });
        }
        
        function add_to_page_array (data){
            full_page_array.push(data)
        }
        
        function renderPageData(container, template, collection, type){
            var item_list = [];
            var item_rendered = [];
            var template_html = $(template).html();
            Mustache.parse(template_html);   // optional, speeds up future uses
            $.each( collection , function( key, val ) {
                var title = val.title.split(" - ");
                val.title = title[1]
                
                var rendered = Mustache.render(template_html,val);
                item_rendered.push(rendered);
            });
            $(container).show();
            $(container).html(item_rendered.join(''));
        };
        
        function submit_contest(slug, e) {
            // Set up campaign monitor name field
            $('#fieldName').val($('#fieldFirstName').val() + " " + $('#fieldLastName').val());
            var confirmation_code = moment().format();
            $('#ieldydiyily').val(confirmation_code);
            console.log("code", $('#ieldydiyily').val())
            
            // Format contest data for MM
            var contest_data = {};
            contest_data.full_name = $('#fieldFirstName').val() + " " + $('#fieldLastName').val();
            contest_data.email = $('#fieldEmail').val();
            contest_data.phone_number = $('#fieldwdiat').val();
            contest_data.alt_phone_number = $('#fieldwdiad').val();
            contest_data.lost_or_found = $('#fieldwdiah').find(":selected").text();
            contest_data.item_type = $('#fieldwdifi').find(":selected").text();
            contest_data.date = $('#fieldwdizl').val();
            contest_data.time = $('#fieldwdifh').val();
            contest_data.item_description = $('#fieldwdifk').val();
            contest_data.reference_code = confirmation_code;
            
            // Format email data
            var contact_form = {};
            // contact_form.send_to = "tbcinfo@cushwake.com";
            contact_form.send_to = "caitlin@mobilefringe.com";
            contact_form.subject = "Lost & Found Form Submission";
            var body = {};
            body["Full Name"] = $('#fieldName').val();
            body["Email"] = $('#fieldEmail').val();
            body["Phone Number"] = $('#fieldwdiat').val();
            body["Alternate Phone Number"] = $('#fieldwdiad').val();
            body["Was Item Lost or Found?"] = $('#fieldwdiah').find(":selected").text();
            body["Type of Item"] = $('#fieldwdifi').find(":selected").text();
            body["Date"] = $('#fieldwdizl').val();
            body["Time"] = $('#fieldwdifh').val();
            body["Item Description"] = $('#fieldwdifk').val();
            body["Item Location"] = $('#fieldwdifu').val();
            body["Reference Code"] = confirmation_code;

            // Sending email
            send_data = {};
            send_data.url = "https://www.mallmaverick.com/send_contact_email";
            send_data.form_data = JSON.stringify(serializeObject(contact_form));
            contact_form.body = body;

            // $.ajax({
            //     url : send_data.url,
            //     type: "POST",
            //     data : contact_form,
            //     success: function(data, textStatus, jqXHR){
            //         var contest_entry = {};
            //         contest_entry.json = contest_data;
            //         var propertyDetails = getPropertyDetails();
            //         var host = propertyDetails.mm_host.replace("http:", "");
            //         var url = host + "/contests/" + slug + "/json_entry";
            //         $.ajax({
            //             url: url,
            //             type: "POST",
            //             data: contest_entry,
            //             async: false,
            //             success: function(data) {
            //               console.log("mm post successful");
            //               e.target.submit();
            //               $("#send_contact_success").show();
            //             },
            //             error: function(data){
            //                 console.log("error data:" , data);
            //                 $("#send_contact_error").show();
            //             }
            //         });
            //     },
            //     error: function (jqXHR, textStatus, errorThrown){
            //       console.log("Data load error: " + error.message);
            //     }
            // });
        }
        
        function serializeObject(obj) {
            var newObj = [];
            $.each(obj, function(key, value) {
                var tempVal = {};
                tempVal.name = key;
                tempVal.value = value;
                newObj.push(tempVal);
            });
            return newObj;
        }
        function renderGeneral(container, template, collection){
            var item_list = [];
            var item_rendered = [];
            var template_html = $(template).html();
            Mustache.parse(template_html);   // optional, speeds up future uses
            $.each( collection , function( key, val ) {
                var rendered = Mustache.render(template_html,val);
                item_rendered.push(rendered);
            });
            $(container).show();
            $(container).html(item_rendered.join(''));
        }
        loadMallDataCached(renderAll); 
    })
</script>