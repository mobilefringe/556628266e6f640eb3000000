<style>
.store_detail_content{
        margin-bottom:0;
        border-bottom:none;
        padding-bottom:0;
    }
    .socialize_div {
        margin-top:80px;
    }
    .socialize_text{
        margin-top:5px;
        
    }
    .socialize_social_icons{
        margin-top:0;
    }
    
    #job_header, #promo_header{
        margin-top:40px;
        margin-bottom:20px;
    }
    
    .store_promo_ul{
        margin-top:0;
    }
    
    #left_image{
        display:block;
    }
    #right_image{
        display:block;
    }
    
    
    @media (max-width: 767px) {
        .hours_day, .hours_time {
            font-size:12pt;
        }    
    }
    
    /*map styles*/
    #IE_map{
        margin:auto;
        height:400px;
    }
    #mobileMap{
        display:none!important;
    }
    #desktopMap{
        display:block!important;
    }
    @media (max-width: 768px) {
        #iFrame1 {
            display: none;
            min-height: 400px;
        }
         #mobileMap{
            display:block!important;
        }
        #desktopMap{
            display:none!important;
        }
    }
</style>

<div id="page_banner">
    <div class="banner_wrapper">
        <div id="store_name_container">
            <script id="store_name_template" type="x-tmpl-mustache/text">
                <h1 class="page_headline">{{name}}</h1>
            </script>
        </div>
        <div class="missing_out_div">
            <p onclick="javascript:toggle_news_form()">Get the Latest<i id="fear_caret" class="fa fa-caret-down"></i></p>
            <div class="hidden_newsletter_form">
                <form style="font-size:12px" id="banner_newsletter">
                    <span>
                        <input id="banner_email" name="cm-iixuu-iixuu" type="email" required  placeholder="Email address"/>
                        <button type="submit" id="banner_submit">Subscribe</button>
                    </span>
                    <br>
                    <input id="banner_agree_terms" type="checkbox" required value="I agree to receive newsletters from The Bay Centre">
                    <label for="banner_aggree_terms" class="checkbox_lbl">I agree to receive newsletters from The Bay Centre</label>
                    <input type="hidden" name="cm-f-jhtykd" id ="banner_source" />
                    <input type="hidden" name="cm-f-jhtykh" id="banner_terms"/>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="share_this_icon_div">
    <span class='st_sharethis'></span>   
</div>


<div id="main_container">
    <div id="page_content"> 
        <div class="store_detail_content">
            <div class="detail_left_div">
                <button class="gray_pill back_to_list" onclick="window.location.href='/stores'">View All Stores</button>
                <div id="pop-over"></div>
                <p class="store_detail_title">store location</p>
                    <!--map-->
                    <div class="map-container"  id="desktopMap">
                       <div id="mapsvg_store_detail"></div>  
                    </div>
                    
                    <div id="mobileMap" style="display:none;">
                       <iframe src="https://mf-map.netlify.com/map?iframe=true&staging=true&subdomain=baycentre&hideStoreList=true" frameborder="0" width="100%" height="100%" id="iFrame1" sandbox="allow-top-navigation allow-scripts allow-same-origin"></iframe>
                       <img id="IE_map" src="">
                    </div>

                    
                <div id="store_detail_left_content_container">
                    <script id="store_detail_left_content_template" type="x-tmpl-mustache/text">
                        <p class="store_detail_description">{{description}}</p>
                    </script>
                </div>
            </div>
            <div class="detail_right_div">
                <div id="store_detail_right_content_container">
                    <script id="store_detail_right_content_template" type="x-tmpl-mustache/text">
                        <img src="{{alt_store_front_url}}" class="store_front"/>
                        <div class="contact_div">
                            <div class="contact_object" id="contact_phone" onclick="window.location.href='tel:{{phone}}'">
                                <img src="//codecloud.cdn.speedyrails.net/sites/556628266e6f640eb3000000/d52d75490b904799149bedd8a0f02ffe/storedetail_icon_phone.png" class="detail_icon" alt="phone">
                                <p> {{phone}}</p>
                            </div>
                            <div class="contact_object" id="contact_website" onclick="window.open('http://{{website}}','_blank')">
                                <img src="//codecloud.cdn.speedyrails.net/sites/556628266e6f640eb3000000/d52d75490b904799149bedd8a0f02ffe/storedetail_icon_web.png" class="detail_icon" alt="website">
                                <p>visit website</p>
                            </div>
                        </div>
                    </script>
                </div>
                <div class="hours_div">  
                    <p class="hours_title">Hours</p>
                    <div id="store_detail_hours_container">
                        <script id="store_detail_hours_template" type="x-tmpl-mustache/text">
                            <div class="hours_object">
                                <p class="hours_day">{{day}}</p>
                                <p class="hours_time">{{hour_string}}</p>
                            </div>
                        </script>    
                    </div>
                    <p class="hours_day" style="font-style:italic">Hours subject to change</p>
                </div>
            </div>
        </div>

        <div class="store_promo_content">
            <p class="store_detail_title" id="promo_header">Current Promotions</p>
            <ul class="store_promo_ul" id="store_promo_container">
                <script id="store_promo_template" type="x-tmpl-mustache/text">
                    <li>
                        <div class="promo_left_div">
                            <p class="store_detail_title">{{name}}</p>
                            <p class="store_detail_description">{{description}}</p>
                            <div class="store_promo_buttons">
                                <span>
                                    <a href="/promotions/{{slug}}">
                                        <img src="//codecloud.cdn.speedyrails.net/sites/556628266e6f640eb3000000/dc4d28f03d666b522490b234c8f18b2a/promo_icon_more.png" class="store_promo_button_icon" alt="store_promo_button_icon">
                                        <p>read more</p>
                                    </a> 
                                    <span class='st_sharethis' id="promo_share_this"></span>
                                </span>
                            </div>
                        </div>
                        <div class="promo_right_div">
                            <a href="{{alt_promo_image_url}}" rel="lightbox-gallery" title="{{name}}">
                                <img class="store_promo_img" alt="photo_{{name}}" src="{{alt_promo_image_url}}"/>
                            </a>
                        </div>
                    </li>
                </script>
            </ul>
        </div>

        <div class="store_promo_content">
            <p class="store_detail_title" id="job_header">Current Job Opportunities</p>
            <ul class="store_promo_ul" id="store_job_container">
                <script id="store_job_template" type="x-tmpl-mustache/text">
                    <li>
                        <div class="promo_left_div">
                            <p class="store_detail_title">{{name}}</p>
                            <p class="store_detail_description">{{description}}</p>
                            <div class="store_promo_buttons">
                                <span>
                                    <a href="/jobs/{{slug}}">
                                        <img src="//codecloud.cdn.speedyrails.net/sites/556628266e6f640eb3000000/dc4d28f03d666b522490b234c8f18b2a/promo_icon_more.png" class="store_promo_button_icon" alt="store_promo_button_icon">
                                        <p>read more</p>
                                    </a> 
                                    <span class='st_sharethis' id="promo_share_this"></span> 
                                    {{{website_div}}}
                                </span>
                            </div>
                        </div>
                    </li>
                </script>
            </ul>
        </div>
    </div>
</div>




<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.js"></script>
<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/raphael.js"></script>
<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.mousewheel.js"></script>
<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/system/site_images/photos/000/005/107/original/mallmaverick_svgmap.js?1412885524"></script>

<script>
    $(document).ready(function() {
        let store_details = null;
        function renderPageData(){
            var page_banner = getRepoDetailsByName('Store Page').images;
            var banner_url = "";
            $.each(page_banner, function(key, val){
                banner_url = val.image_url;
            });
            $("#page_banner").css({backgroundImage: "url(" + banner_url + ")"});
            
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            
            store_details = getStoreDetailsBySlug(slug);  
            
            console.log(slug, store_details)
            
            if (store_details.store_hours != ""){
                var hours = getHoursForStoreSlug(store_details.slug);
                hours = hours.sortBy(function(o){ return o.day_of_week });
            } else {
                var hours = getPropertyHours();
                prop_hours = []
                $.each( hours , function( key, val ) {
                    if (val.store_id == null && val.is_holiday == false){
                        prop_hours.push(val)
                    }
                });
                hours = prop_hours;
            }

            var store_promos = getPromotionsForIds(store_details.promotions);
            promo_array = []
            $.each( store_promos , function( key, val ){
                if (val.description.length > 110) {
                   val.description =  val.description.substring(0,300)+'...';
                } 
                today = moment();
                webDate = moment(val.show_on_web_date);
                if (today >= webDate) {
                    promo_array.push(val)
                } 
            });
            store_promos = promo_array;
            
            var jobs = getJobsForIds(store_details.jobs);
            jobs = jobs.reverse();
            jobs_array = []
            $.each( jobs , function( key, val ){
                today = moment();
                webDate = moment(val.show_on_web_date);
                if (today >= webDate) {
                    jobs_array.push(val)
                } 
            });
            jobs = jobs_array;
        
            renderDetailData("#store_name_container", "#store_name_template", store_details, "store_desc")
            renderDetailData("#store_detail_left_content_container", "#store_detail_left_content_template", store_details, "store_desc")
            renderDetailData("#store_detail_right_content_container", "#store_detail_right_content_template", store_details, "store_desc")
            renderDetailData("#store_detail_hours_container","#store_detail_hours_template", hours, "store_hours")
            renderDetailData("#store_promo_container","#store_promo_template", store_promos, "store_promos")
            renderDetailData("#store_job_container","#store_job_template", jobs, "store_jobs")
            
            $.getScript("https://cdn.jsdelivr.net/slimbox/2.0.5/js/slimbox2.js");
            $('head').append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/slimbox/2.0.5/css/slimbox2.css" type="text/css" media="screen" />');
            $(".loading_overlay").hide();
            $("#page_content").show();
            
            var stores = getStoresList();
            regions = {}
            $.each( stores , function( key, val ) {
                if(val.svgmap_region != null && typeof(val.svgmap_region)  != 'undefined'){
                    obj = {};
                    obj["tooltip"] = "<div class='tooltip_div'><p class='tooltip_name'>"+val.name+"</p></div>"
                    obj["attr"] = {}
                    obj["attr"]["href"] = "/stores/"+val.slug
                    regions[val.svgmap_region] = obj
                }
            });
            load_map(regions, store_details);
        }
        
        
        
         $('#iFrame1').css('display','block')
                    console.log('IE ' + detectIE());
                    if(detectIE()){
                        var svg_url = '//mallmaverick.com'+getPropertyDetails().svgmap_url;
                        $('#iFrame1').remove();
                        $("#IE_map").attr("src", svg_url)
                    } else {
                        $('#IE_map').remove();
                }
                //setup map
                var stores = getStoresList();
                regions = {}
                $.each( stores , function( key, val ) {
                    if(val.svgmap_region != null && typeof(val.svgmap_region)  != 'undefined'){
                        if(!val.store_front_url_abs ||  val.store_front_url_abs.indexOf('missing.png') > -1 || val.store_front_url_abs.length === 0){
                            val.store_front_url_abs = '//codecloud.cdn.speedyrails.net/sites/55ddf3f86e6f640775000000/a22fcf023d728855c6f575ba100806d7/default.jpg'
                        } 
                        obj = {};
                        obj["tooltip"] = "<p class='tooltip_name'>"+val.name+"</p>"
                        obj["popover"] = "<p class='tooltip_name'>"+val.name+"</p> <a href='/stores/"+val.slug+"'  >View Details</a>"
                        obj["attr"] = {}
                        // obj["attr"]["href"] = "/stores/"+val.slug
                        regions[val.svgmap_region] = obj
                    }
                });
                // renderStoreList('#stores_container','#stores_template', stores, "A", "Z");
                
                var map = $('#mapsvg_store_detail').mapSvg({
                    source: '//assets.mallmaverickstaging.com'+getPropertyDetails().svgmap_url,
                    colors: {stroke: '#fff', selected: "#D8836C", hover: "#a6a6a6"},
                    disableAll: true,
                    regions: regions,
                    height:1700,
                    width:2300,
                    tooltipsMode:'custom',
                    zoom:true,
                    zoomButtons: {'show': true, 'location': 'left'},
                    pan:true,
                    cursor:'pointer',
                    responsive:true,
                    zoomLimit: [0,5],
                    onClick: function(e,mapsvg){
                      var region = this;
                      mapsvg.marksHide();
                      console.log(this.id);
                      drop_pin(region.id,mapsvg)
                    }
                });
                
                $('.map_pin_a').click(function(e){
                    e.preventDefault();
                    var id = $(this).attr('data-svg')
                    map_pin(id)
                })
                
                function map_pin(value){
                    map.marksHide();
                    if (value){
                        drop_pin(value, map);    
                    }
                }
                drop_pin(store_details.svgmap_region, map)

        
        
        
        loadMallDataCached(renderPageData);
    });
     // Enhanced map code
    window.addEventListener('message', function(event) {
        // IMPORTANT: check the origin of the data! 
        if (event.origin.startsWith('https://mf-map.netlify.com') && event.data.event === "store-details-clicked") { 
            // The data was sent from your site.
            // Data sent with postMessage is stored in event.data:
            if(event.data && event.data.selectedStore) {
                var store = event.data.selectedStore
                window.location.href= "/stores/"+store.slug
            }
        } else if (event.origin.startsWith('https://mf-map.netlify.com') && event.data.event === "map-loaded") {
            if(event.data) {
                var loading = event.data.loading;
                if (!loading){
                    let frame = document.getElementById('iFrame1');
                    frame.contentWindow.postMessage({ event: "select-store", selectedStore: store_details }, '*');
                }
            }
        }
    });
</script>